<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard DIANA VPN</title>
    <!-- Import Font: Outfit -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-color: #ffffff;
            --text-muted: #a0a0a0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Outfit', sans-serif;
        }

        body {
            background: linear-gradient(to bottom, #0f0c29, #302b63, #24243e);
            min-height: 100vh;
            color: var(--text-color);
            display: flex;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            border-right: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 40px;
            text-align: center;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-item {
            padding: 15px 20px;
            margin-bottom: 10px;
            border-radius: 10px;
            cursor: pointer;
            transition: 0.3s;
            color: var(--text-muted);
            display: flex;
            align-items: center;
        }

        .nav-item:hover, .nav-item.active {
            background: var(--glass-bg);
            color: #fff;
            border: 1px solid var(--glass-border);
        }

        .nav-item i {
            margin-right: 15px;
            width: 20px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        .stat-title {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
        }

        /* Sections */
        .section {
            display: none;
        }
        .section.active {
            display: block;
        }

        .card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
        }

        h2 { margin-bottom: 20px; }

        .btn {
            background: var(--primary-gradient);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: 0.3s;
        }
        .btn:hover { opacity: 0.9; }

        .btn-danger {
            background: #ff4b4b;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            text-align: left;
            padding: 15px;
            border-bottom: 1px solid var(--glass-border);
            color: var(--text-muted);
        }
        th { color: #fff; }

        /* Toast */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        .toast {
            background: rgba(15, 12, 41, 0.9);
            border-left: 4px solid;
            color: #fff;
            padding: 15px 25px;
            margin-bottom: 10px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            animation: slideIn 0.5s ease forwards;
            min-width: 250px;
        }
        .toast.success { border-color: #00d26a; }
        .toast.error { border-color: #ff4b4b; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* Form Controls */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: var(--text-muted); }
        .form-control {
            width: 100%;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border: 1px solid var(--glass-border);
            border-radius: 5px;
            color: #fff;
        }
        .form-control:focus { outline: none; border-color: #667eea; }

    </style>
</head>
<body>

    <div id="toast-container"></div>

    <div class="sidebar">
        <div class="logo">DIANA VPN</div>
        <div class="nav-item active" onclick="showSection('dashboard', this)">
            <i class="fas fa-home"></i> Dashboard
        </div>
        <div class="nav-item" onclick="showSection('ssh', this)">
            <i class="fas fa-terminal"></i> SSH
        </div>
        <div class="nav-item" onclick="showSection('vmess', this)">
            <i class="fas fa-share-alt"></i> VMESS
        </div>
        <div class="nav-item" onclick="showSection('vless', this)">
            <i class="fas fa-project-diagram"></i> VLESS
        </div>
        <div class="nav-item" onclick="showSection('trojan', this)">
            <i class="fas fa-horse-head"></i> TROJAN
        </div>
        <div class="nav-item" onclick="showSection('ss', this)">
            <i class="fas fa-ghost"></i> SHADOWSOCKS
        </div>
        <div class="nav-item" onclick="showSection('settings', this)">
            <i class="fas fa-cog"></i> Settings
        </div>
        {% if is_admin %}
        <div class="nav-item" onclick="showSection('users', this)">
            <i class="fas fa-users"></i> Users
        </div>
        {% endif %}
        <div class="nav-item" onclick="updateSystem()">
            <i class="fas fa-sync-alt"></i> Update
        </div>
        <a href="/logout" style="text-decoration: none;">
            <div class="nav-item" style="margin-top: auto; color: #ff4b4b;">
                <i class="fas fa-sign-out-alt"></i> Logout
            </div>
        </a>
    </div>

    <div class="main-content">
        <div class="header">
            <h1>Selamat Datang, <span id="userName">{{ name }}</span></h1>
        </div>

        <!-- Dashboard Home -->
        <div id="dashboard" class="section active">
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-title">CPU Usage</div>
                    <div class="stat-value" id="cpu-val">Loading...</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">RAM Usage</div>
                    <div class="stat-value" id="ram-val">Loading...</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Active Accounts</div>
                    <div class="stat-value" id="acc-count">0</div>
                </div>
            </div>

            <div class="card">
                <h2>System Info</h2>
                <p>Status: Running</p>
                <p>Version: 1.0.0</p>
            </div>
        </div>

        <!-- Protocol Sections Template -->

        <div id="ssh" class="section">
            <div class="card">
                <h2>Manage SSH</h2>
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" class="form-control" id="ssh-user">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="text" class="form-control" id="ssh-pass">
                </div>
                <div class="form-group">
                    <label>Duration</label>
                    <select class="form-control" id="ssh-duration">
                        <option value="3">3 Days</option>
                        <option value="7">7 Days</option>
                        <option value="15">15 Days</option>
                        <option value="30" selected>30 Days</option>
                    </select>
                </div>
                <button class="btn" onclick="createAccount('ssh')">Create SSH</button>
            </div>
            <div class="card">
                <h3>Active SSH Accounts</h3>
                <div id="ssh-list">Loading...</div>
            </div>
        </div>

        <div id="vmess" class="section">
            <div class="card">
                <h2>Manage VMESS</h2>
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" class="form-control" id="vmess-user">
                </div>
                <div class="form-group">
                    <label>Duration</label>
                    <select class="form-control" id="vmess-duration">
                        <option value="3">3 Days</option>
                        <option value="7">7 Days</option>
                        <option value="15">15 Days</option>
                        <option value="30" selected>30 Days</option>
                    </select>
                </div>
                <button class="btn" onclick="createAccount('vmess')">Create VMESS</button>
            </div>
            <div class="card">
                <h3>Active VMESS Accounts</h3>
                <div id="vmess-list">Loading...</div>
            </div>
        </div>

        <div id="vless" class="section">
            <div class="card"><h2>Manage VLESS</h2>
            <div class="form-group"><label>Username</label><input type="text" class="form-control" id="vless-user"></div>
            <div class="form-group">
                <label>Duration</label>
                <select class="form-control" id="vless-duration">
                    <option value="3">3 Days</option>
                    <option value="7">7 Days</option>
                    <option value="15">15 Days</option>
                    <option value="30" selected>30 Days</option>
                </select>
            </div>
            <button class="btn" onclick="createAccount('vless')">Create VLESS</button></div>
            <div class="card"><h3>Active VLESS Accounts</h3><div id="vless-list">Loading...</div></div>
        </div>

        <div id="trojan" class="section">
            <div class="card"><h2>Manage TROJAN</h2>
            <div class="form-group"><label>Username</label><input type="text" class="form-control" id="trojan-user"></div>
            <div class="form-group">
                <label>Duration</label>
                <select class="form-control" id="trojan-duration">
                    <option value="3">3 Days</option>
                    <option value="7">7 Days</option>
                    <option value="15">15 Days</option>
                    <option value="30" selected>30 Days</option>
                </select>
            </div>
            <button class="btn" onclick="createAccount('trojan')">Create TROJAN</button></div>
            <div class="card"><h3>Active TROJAN Accounts</h3><div id="trojan-list">Loading...</div></div>
        </div>

        <div id="ss" class="section">
            <div class="card"><h2>Manage SHADOWSOCKS</h2>
            <div class="form-group"><label>Username</label><input type="text" class="form-control" id="ss-user"></div>
             <div class="form-group"><label>Password</label><input type="text" class="form-control" id="ss-pass"></div>
             <div class="form-group">
                <label>Duration</label>
                <select class="form-control" id="ss-duration">
                    <option value="3">3 Days</option>
                    <option value="7">7 Days</option>
                    <option value="15">15 Days</option>
                    <option value="30" selected>30 Days</option>
                </select>
            </div>
            <button class="btn" onclick="createAccount('ss')">Create SS</button></div>
            <div class="card"><h3>Active SS Accounts</h3><div id="ss-list">Loading...</div></div>
        </div>

        <div id="settings" class="section">
            <div class="card">
                <h2>Domain Settings</h2>
                <div class="form-group">
                    <label>Current Domain</label>
                    <input type="text" class="form-control" id="domain-val">
                </div>
                <button class="btn" onclick="updateDomain()">Save Domain</button>
            </div>
        </div>

        {% if is_admin %}
        <div id="users" class="section">
            <div class="card">
                <h2>User Management</h2>
                <div id="user-list">Loading...</div>
            </div>
        </div>
        {% endif %}

    </div>

    <script>
        function escapeHtml(text) {
            if (!text) return text;
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function showSection(id, element) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');

            if(element) {
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                element.classList.add('active');
            }

            if(id === 'users') {
                {% if is_admin %} loadUsers(); {% endif %}
            } else if(id !== 'dashboard' && id !== 'settings') {
                loadAccounts(id);
            }
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        async function updateStats() {
            try {
                const res = await fetch('/api/stats');
                const data = await res.json();
                document.getElementById('cpu-val').innerText = data.cpu + '%';
                document.getElementById('ram-val').innerText = data.ram + '%';
                document.getElementById('acc-count').innerText = data.active_accounts;
            } catch(e) { console.log(e); }
        }

        async function updateSystem() {
             if(!confirm('Update system from repository? Service may restart.')) return;
             try {
                const res = await fetch('/update', {method: 'POST'});
                const data = await res.json();
                if(data.success) showToast(data.message);
                else showToast(data.message, 'error');
             } catch(e) {
                 showToast('Update failed', 'error');
             }
        }

        async function createAccount(type) {
            const user = document.getElementById(type + '-user').value;
            const pass = document.getElementById(type + '-pass') ? document.getElementById(type + '-pass').value : null;
            const duration = document.getElementById(type + '-duration') ? document.getElementById(type + '-duration').value : 30;

            if(!user) return showToast('Username required', 'error');

            try {
                const res = await fetch('/api/account/create', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({type, username: user, password: pass, duration: parseInt(duration)})
                });
                const data = await res.json();
                if(data.success) {
                    showToast('Account created', 'success');
                    loadAccounts(type);
                } else {
                    showToast(data.message, 'error');
                }
            } catch(e) { showToast('Error creating account', 'error'); }
        }

        async function loadAccounts(type) {
            const container = document.getElementById(type + '-list');
            container.innerHTML = 'Loading...';
            try {
                const res = await fetch('/api/account/list?type=' + type);
                const data = await res.json();
                if(data.accounts.length === 0) {
                    container.innerHTML = '<p>No accounts found.</p>';
                    return;
                }

                let html = '<table><thead><tr><th>Username</th><th>Expiry</th><th>Details</th><th>Links</th><th>Action</th></tr></thead><tbody>';
                data.accounts.forEach(acc => {
                    let linkButtons = '';
                    if(acc.links && acc.links.tls) {
                        linkButtons += `<button class="btn" style="padding:5px 10px; margin-right:5px; font-size:0.8rem;" onclick="copyToClipboard('${acc.links.tls}')">Copy TLS</button>`;
                        linkButtons += `<button class="btn" style="padding:5px 10px; margin-right:5px; font-size:0.8rem; background:#4b76a2;" onclick="prompt('TLS Link:', '${acc.links.tls}')">View TLS</button>`;
                    }
                    if(acc.links && acc.links.nontls) {
                        linkButtons += `<button class="btn" style="padding:5px 10px; margin-right:5px; font-size:0.8rem; background:#4b76a2;" onclick="copyToClipboard('${acc.links.nontls}')">Copy NTLS</button>`;
                        linkButtons += `<button class="btn" style="padding:5px 10px; margin-right:5px; font-size:0.8rem; background:#4b76a2;" onclick="prompt('NTLS Link:', '${acc.links.nontls}')">View NTLS</button>`;
                    }
                    if(!linkButtons) linkButtons = '-';

                    // SSH Review Button
                    if(type === 'ssh' && acc.ssh_details) {
                        // Use a safe way to pass the string, possibly encodeURI or store in a map
                        // Storing in a global map is safer than escaping for onclick
                        window.accountDetails = window.accountDetails || {};
                        window.accountDetails[acc.id] = acc.ssh_details;
                        linkButtons = `<button class="btn" style="padding:5px 10px; margin-right:5px; font-size:0.8rem; background:#4b76a2;" onclick="showSSHDetails(${acc.id})">Review</button>`;
                    }

                    html += `<tr>
                        <td>${escapeHtml(acc.username)}</td>
                        <td>${escapeHtml(acc.expiry)}</td>
                        <td>${escapeHtml(acc.details)}</td>
                        <td>${linkButtons}</td>
                        <td><button class="btn btn-danger" onclick="deleteAccount(${acc.id}, '${type}')">Delete</button></td>
                    </tr>`;
                });
                html += '</tbody></table>';
                container.innerHTML = html;
            } catch(e) { container.innerHTML = 'Error loading accounts'; }
        }

        async function loadDomain() {
            try {
                const res = await fetch('/api/domain');
                const data = await res.json();
                document.getElementById('domain-val').value = data.domain;
            } catch(e) { console.error(e); }
        }

        async function updateDomain() {
            const domain = document.getElementById('domain-val').value;
            try {
                const res = await fetch('/api/domain', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({domain})
                });
                const data = await res.json();
                if(data.success) showToast('Domain updated', 'success');
                else showToast(data.message, 'error');
            } catch(e) { showToast('Error updating domain', 'error'); }
        }

        function showSSHDetails(id) {
            const details = window.accountDetails[id];
            // Simple alert for now, or a modal if we had one.
            // Alert box is hard to copy from. Better use a prompt or a custom modal.
            // Let's use a textarea in a new overlay/modal for easy copying.
            createModal('SSH Account Details', `<textarea style="width:100%; height:300px; background:#1a1a2e; color:#fff; border:1px solid #444; padding:10px;">${details}</textarea>`);
        }

        function createModal(title, content) {
            let modal = document.getElementById('custom-modal');
            if(!modal) {
                modal = document.createElement('div');
                modal.id = 'custom-modal';
                modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; display:flex; justify-content:center; align-items:center;';
                document.body.appendChild(modal);
            }
            modal.innerHTML = `
                <div style="background:#0f0c29; border:1px solid rgba(255,255,255,0.1); padding:20px; border-radius:10px; width:90%; max-width:500px; position:relative;">
                    <h2 style="margin-top:0;">${title}</h2>
                    <div style="margin:20px 0;">${content}</div>
                    <div style="text-align:right;">
                        <button class="btn" onclick="document.getElementById('custom-modal').style.display='none'">Close</button>
                    </div>
                </div>
            `;
            modal.style.display = 'flex';
        }

        {% if is_admin %}
        async function loadUsers() {
            const container = document.getElementById('user-list');
            container.innerHTML = 'Loading...';
            try {
                const res = await fetch('/api/admin/users');
                const data = await res.json();

                let html = '<table><thead><tr><th>Name</th><th>Email</th><th>Status</th><th>Action</th></tr></thead><tbody>';
                data.users.forEach(u => {
                    let status = u.is_approved ? '<span style="color:#00d26a">Approved</span>' : '<span style="color:#ff4b4b">Pending</span>';
                    let action = '';
                    if(!u.is_approved) {
                        action += `<button class="btn" style="padding:5px 10px; margin-right:5px;" onclick="approveUser(${u.id})">Approve</button>`;
                    }
                    if(!u.is_admin) { // Can't delete admin easily to prevent lockout
                         action += `<button class="btn btn-danger" style="padding:5px 10px;" onclick="rejectUser(${u.id})">Delete</button>`;
                    }
                    action += `<button class="btn" style="padding:5px 10px; margin-left:5px; background:#f0ad4e;" onclick="openEditUser(${u.id}, '${escapeHtml(u.name)}', '${escapeHtml(u.email)}')">Edit</button>`;

                    html += `<tr>
                        <td>${escapeHtml(u.name)} ${u.is_admin ? '(Admin)' : ''}</td>
                        <td>${escapeHtml(u.email)}</td>
                        <td>${status}</td>
                        <td>${action}</td>
                    </tr>`;
                });
                html += '</tbody></table>';
                container.innerHTML = html;
            } catch(e) { container.innerHTML = 'Error loading users'; }
        }

        async function approveUser(id) {
             try {
                const res = await fetch('/api/admin/approve/' + id, {method: 'POST'});
                const data = await res.json();
                if(data.success) { showToast('Approved', 'success'); loadUsers(); }
                else showToast(data.message, 'error');
             } catch(e) { showToast('Error', 'error'); }
        }

        async function rejectUser(id) {
             if(!confirm('Delete this user?')) return;
             try {
                const res = await fetch('/api/admin/reject/' + id, {method: 'POST'});
                const data = await res.json();
                if(data.success) { showToast('Deleted', 'success'); loadUsers(); }
                else showToast(data.message, 'error');
             } catch(e) { showToast('Error', 'error'); }
        }

        function openEditUser(id, name, email) {
            const formHtml = `
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" class="form-control" id="edit-name" value="${name}">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" class="form-control" id="edit-email" value="${email}">
                </div>
                <div class="form-group">
                    <label>New Password (Optional)</label>
                    <input type="password" class="form-control" id="edit-pass" placeholder="Leave empty to keep current">
                </div>
                <button class="btn" onclick="submitEditUser(${id})">Save Changes</button>
            `;
            createModal('Edit User', formHtml);
        }

        async function submitEditUser(id) {
            const name = document.getElementById('edit-name').value;
            const email = document.getElementById('edit-email').value;
            const password = document.getElementById('edit-pass').value;

            try {
                const res = await fetch('/api/admin/edit_user/' + id, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name, email, password})
                });
                const data = await res.json();
                if(data.success) {
                    showToast('User updated', 'success');
                    document.getElementById('custom-modal').style.display='none';
                    loadUsers();
                } else {
                    showToast(data.message, 'error');
                }
            } catch(e) { showToast('Error updating user', 'error'); }
        }
        {% endif %}

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('Link copied to clipboard', 'success');
            }).catch(err => {
                showToast('Failed to copy', 'error');
            });
        }

        async function deleteAccount(id, type) {
            if(!confirm('Delete this account?')) return;
            try {
                const res = await fetch('/api/account/delete/' + id, {method: 'DELETE'});
                const data = await res.json();
                if(data.success) {
                    showToast('Deleted', 'success');
                    loadAccounts(type);
                } else {
                    showToast('Failed to delete', 'error');
                }
            } catch(e) { showToast('Error', 'error'); }
        }

        // Init
        setInterval(updateStats, 5000);
        updateStats();
        loadDomain();

    </script>
</body>
</html>
